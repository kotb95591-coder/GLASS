{% extends "base.html" %}

{% block content %}
<div class="app-container">
    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div class="sidebar glass-panel">
        <div class="sidebar-header">
            <div class="user-info">
                <img src="{{ user.avatar_url }}" alt="Avatar" class="avatar">
                <span class="username">{{ user.username }}</span>
                {% if user.username == '@' %}
                <span class="admin-badge">üëë</span>
                {% endif %}
            </div>
            <div class="balance">
                ü™ô {{ user.glass_balance }}
            </div>
        </div>

        <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" placeholder="üîç –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." class="glass-input" id="user-search">
            </div>
            <div id="search-results" class="search-results"></div>
        </div>

        <!-- –õ–∏—á–Ω—ã–π —á–∞—Ç —Å –±–æ—Ç–æ–º -->
        <div class="chats-list" id="chats-list">
            <div class="chat-item active" data-user-id="1" data-username="GSLASE_Bot">
                <div class="chat-avatar">ü§ñ</div>
                <div class="chat-info">
                    <div class="chat-name">GSLASE –ë–æ—Ç</div>
                    <div class="chat-last-message">–í–∞—à–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                </div>
            </div>

            <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        {% if user.username == '@' %}
        <div class="admin-link">
            <a href="{{ url_for('admin_panel') }}" class="glass-button">üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
        </div>
        {% endif %}
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <div class="chat-area">
        <div class="chat-header glass-panel">
            <h3 id="current-chat-name">GSLASE –ë–æ—Ç</h3>
            <div class="chat-actions">
                {% if user.username == '@' and currentReceiverId != 1 %}
                <button class="glass-button small" onclick="showAdminPanel('{{ currentUsername }}')">üëë</button>
                {% endif %}
            </div>
        </div>

        <div class="messages-container" id="messages-container">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <div class="message-input-container">
            <input type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="glass-input" id="message-input">
            <button class="glass-button send-button" onclick="sendMessage()">‚û§</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏–π -->
<div id="admin-modal" class="modal">
    <div class="modal-content glass-panel">
        <span class="close" onclick="closeAdminModal()">&times;</span>
        <h3>üëë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h3>
        <div id="user-info"></div>
        <div class="admin-actions-modal">
            <input type="number" class="glass-input" id="glass-amount" placeholder="–ö–æ–ª-–≤–æ —Å—Ç–µ–∫–ª–æ–≤" min="1">
            <button class="glass-button" onclick="giveGlassToUser()">–í—ã–¥–∞—Ç—å —Å—Ç–µ–∫–ª—ã</button>
            <div class="action-buttons">
                <button class="glass-button danger" onclick="banUser()">–ó–∞–±–∞–Ω–∏—Ç—å</button>
                <button class="glass-button success" onclick="unbanUser()">–†–∞–∑–±–∞–Ω–∏—Ç—å</button>
            </div>
            <input type="password" class="glass-input" id="new-password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            <button class="glass-button warning" onclick="changePassword()">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        </div>
    </div>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å–Ω–∏–∑—É -->
<div class="bottom-nav">
    <button class="nav-item active" onclick="showChatList()">üí¨</button>
    <button class="nav-item" onclick="showChannels()">üì¢</button>
    <button class="nav-item" onclick="showSettings()">‚öôÔ∏è</button>
    <button class="nav-item" onclick="logout()">üö™</button>
</div>

<script>
let currentReceiverId = 1;
let currentUsername = 'GSLASE_Bot';
let activeChats = new Set([1]);
let searchTimeout = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
function loadUserChats() {
    fetch('/api/user_chats')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const chatsList = document.getElementById('chats-list');

            // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç—ã –∫—Ä–æ–º–µ –±–æ—Ç–∞ (–∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –µ—Å—Ç—å)
            data.chats.forEach(chat => {
                if (chat.other_user_id !== 1 && !activeChats.has(chat.other_user_id)) {
                    activeChats.add(chat.other_user_id);
                    addChatToSidebar(chat.other_user_id, chat.other_username);
                }
            });
        }
    })
    .catch(error => {
        console.error('Error loading chats:', error);
    });
}

// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
document.getElementById('user-search').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    const resultsContainer = document.getElementById('search-results');

    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }

    if (query.length === 0) {
        resultsContainer.innerHTML = '';
        resultsContainer.style.display = 'none';
        return;
    }

    searchTimeout = setTimeout(() => {
        searchUsers(query);
    }, 300);
});

function searchUsers(query) {
    const resultsContainer = document.getElementById('search-results');

    fetch(`/api/search_users?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
        resultsContainer.innerHTML = '';

        if (data.status === 'error') {
            resultsContainer.innerHTML = '<div class="no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            return;
        }

        if (!data.users || data.users.length === 0) {
            resultsContainer.innerHTML = '<div class="no-results">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            resultsContainer.style.display = 'block';
            return;
        }

        data.users.forEach(user => {
            const userElement = document.createElement('div');
            userElement.className = 'search-result-item';
            userElement.innerHTML = `
                <div class="user-avatar">${user.username[0].toUpperCase()}</div>
                <div class="user-name">${user.username}</div>
                <button class="glass-button small" onclick="startChat(${user.id}, '${user.username}')">
                    üí¨
                </button>
            `;
            resultsContainer.appendChild(userElement);
        });

        resultsContainer.style.display = 'block';
    })
    .catch(error => {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<div class="no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
        resultsContainer.style.display = 'block';
    });
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
document.addEventListener('click', function(e) {
    const searchContainer = document.querySelector('.search-container');
    const searchInput = document.getElementById('user-search');
    const resultsContainer = document.getElementById('search-results');

    if (!searchContainer.contains(e.target) && e.target !== searchInput) {
        resultsContainer.style.display = 'none';
    }
});

function startChat(userId, username) {
    // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º/–ø—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    fetch('/api/create_chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ receiver_id: userId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            if (!activeChats.has(userId)) {
                activeChats.add(userId);
                addChatToSidebar(userId, username);
            }

            switchToChat(userId, username);
            document.getElementById('user-search').value = '';
            document.getElementById('search-results').style.display = 'none';
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞: ' + data.message);
        }
    });
}

function addChatToSidebar(userId, username) {
    const chatsList = document.getElementById('chats-list');
    const chatItem = document.createElement('div');
    chatItem.className = 'chat-item';
    chatItem.dataset.userId = userId;
    chatItem.dataset.username = username;
    chatItem.innerHTML = `
        <div class="chat-avatar">${username[0].toUpperCase()}</div>
        <div class="chat-info">
            <div class="chat-name">${username}</div>
            <div class="chat-last-message">–õ–∏—á–Ω—ã–π —á–∞—Ç</div>
        </div>
    `;

    chatItem.addEventListener('click', function() {
        switchToChat(userId, username);
    });

    {% if user.username == '@' %}
    chatItem.addEventListener('dblclick', function() {
        showAdminPanel(username);
    });
    {% endif %}

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º, –Ω–æ –ø–µ—Ä–µ–¥ –¥—Ä—É–≥–∏–º–∏ —á–∞—Ç–∞–º–∏
    const botChat = document.querySelector('.chat-item[data-user-id="1"]');
    if (botChat && botChat.nextSibling) {
        chatsList.insertBefore(chatItem, botChat.nextSibling);
    } else {
        chatsList.appendChild(chatItem);
    }
}

function switchToChat(userId, username) {
    document.querySelectorAll('.chat-item').forEach(chat => {
        chat.classList.remove('active');
    });

    const currentChat = document.querySelector(`.chat-item[data-user-id="${userId}"]`);
    if (currentChat) {
        currentChat.classList.add('active');
    }

    currentReceiverId = userId;
    currentUsername = username;
    document.getElementById('current-chat-name').textContent = username;

    loadMessages(userId);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º
document.querySelector('.chat-item[data-user-id="1"]').addEventListener('click', function() {
    switchToChat(1, 'GSLASE –ë–æ—Ç');
});

{% if user.username == '@' %}
document.querySelector('.chat-item[data-user-id="1"]').addEventListener('dblclick', function() {
    // –ë–æ—Ç–∞ –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
});
{% endif %}

function showAdminPanel(username) {
    fetch(`/api/admin/user_info/${username}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const userInfo = data.user;
            document.getElementById('user-info').innerHTML = `
                <div class="user-details">
                    <p><strong>–õ–æ–≥–∏–Ω:</strong> ${userInfo.username}</p>
                    <p><strong>Email:</strong> ${userInfo.email}</p>
                    <p><strong>–ë–∞–ª–∞–Ω—Å:</strong> ${userInfo.glass_balance} —Å—Ç–µ–∫–ª–æ–≤</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${userInfo.is_banned ? '–ó–∞–±–∞–Ω–µ–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω'}</p>
                </div>
            `;
            document.getElementById('admin-modal').style.display = 'block';
        }
    });
}

function closeAdminModal() {
    document.getElementById('admin-modal').style.display = 'none';
}

function respondToInvitation(invitationId, accept) {
    fetch('/api/invite/respond', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            invitation_id: invitationId,
            accept: accept
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            loadMessages(currentReceiverId);
        }
    });
}

// –§–£–ù–ö–¶–ò–ò –ù–ê–í–ò–ì–ê–¶–ò–ò - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï
function showChatList() {
    // –£–∂–µ –≤–∏–¥–∏–º —á–∞—Ç—ã
    console.log('–ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç—ã');
}

function showChannels() {
    alert('–†–∞–∑–¥–µ–ª –∫–∞–Ω–∞–ª–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function showSettings() {
    window.location.href = "{{ url_for('settings') }}";
}

function logout() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
        window.location.href = "{{ url_for('logout') }}";
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞
function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (!message) return;

    fetch('/api/send_message', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            content: message,
            receiver_id: currentReceiverId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            input.value = '';
            loadMessages(currentReceiverId);
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
    });
}

function loadMessages(receiverId) {
    fetch(`/api/messages/${receiverId}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';

            data.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.is_own ? 'sent' : 'received'}`;

                if (msg.content_type === 'invitation') {
                    messageDiv.innerHTML = `
                        <div class="message-content glass-panel invitation-message">
                            <p>${msg.content}</p>
                            <div class="invitation-actions">
                                <button class="glass-button small success"
                                        onclick="respondToInvitation(${msg.invitation_id}, true)">
                                    ‚úÖ –ü—Ä–∏–Ω—è—Ç—å
                                </button>
                                <button class="glass-button small danger"
                                        onclick="respondToInvitation(${msg.invitation_id}, false)">
                                    ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                            </div>
                        </div>
                        <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-content glass-panel">
                            <strong>${msg.sender}:</strong> ${msg.content}
                        </div>
                        <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                    `;
                }

                container.appendChild(messageDiv);
            });

            scrollToBottom();
        }
    })
    .catch(error => {
        console.error('Error loading messages:', error);
    });
}

function scrollToBottom() {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
}

function giveGlassToUser() {
    const amount = document.getElementById('glass-amount').value;
    if (!amount || amount <= 0) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–µ–∫–ª–æ–≤');
        return;
    }

    fetch('/api/admin/give_glass', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            username: currentUsername,
            amount: parseInt(amount)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`–í—ã–¥–∞–Ω–æ ${amount} —Å—Ç–µ–∫–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${currentUsername}`);
            closeAdminModal();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    });
}

function banUser() {
    if (confirm(`–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${currentUsername}?`)) {
        fetch('/api/admin/ban_user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: currentUsername})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            closeAdminModal();
        });
    }
}

function unbanUser() {
    if (confirm(`–†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${currentUsername}?`)) {
        fetch('/api/admin/unban_user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: currentUsername})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            closeAdminModal();
        });
    }
}

function changePassword() {
    const newPassword = document.getElementById('new-password').value;
    if (!newPassword) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å');
        return;
    }

    if (confirm(`–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è ${currentUsername}?`)) {
        fetch('/api/admin/change_password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: currentUsername,
                new_password: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            closeAdminModal();
        });
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
    const modal = document.getElementById('admin-modal');
    if (event.target == modal) {
        closeAdminModal();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    loadUserChats();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ (–±–æ—Ç–∞)
    loadMessages(currentReceiverId);

    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    setInterval(() => loadMessages(currentReceiverId), 3000);
});
</script>

<style>
.search-container {
    position: relative;
    margin-bottom: 15px;
}

.search-box {
    position: relative;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--primary-bg);
    backdrop-filter: blur(var(--blur-amount));
    border: 1px solid var(--border-color);
    border-radius: 15px;
    margin-top: 5px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.search-result-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background 0.3s ease;
}

.search-result-item:hover {
    background: var(--secondary-bg);
}

.search-result-item:last-child {
    border-bottom: none;
}

.user-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent-color), #9575cd);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    color: white;
    font-weight: bold;
}

.user-name {
    flex: 1;
    font-weight: 500;
}

.no-results {
    padding: 15px;
    text-align: center;
    color: var(--text-secondary);
    font-style: italic;
}

.bottom-nav {
    position: fixed;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
    background: var(--primary-bg);
    backdrop-filter: blur(var(--blur-amount));
    border-radius: 50px;
    padding: 15px 25px;
    border: 1px solid var(--border-color);
    z-index: 1000;
}

.nav-item {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3em;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.nav-item.active,
.nav-item:hover {
    background: var(--accent-color);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

/* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
</style>
{% endblock %}