{% extends "base.html" %}

{% block content %}
<div class="glass-panel admin-panel">
    <h2>üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>

    <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="search-box">
        <input type="text" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." class="glass-input" id="admin-user-search">
        <div id="admin-search-results" class="search-results"></div>
    </div>

    <!-- –í—ã–¥–∞—Ç—å –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º -->
    <div class="admin-section glass-panel">
        <h3>–ú–∞—Å—Å–æ–≤–∞—è –≤—ã–¥–∞—á–∞ —Å—Ç–µ–∫–ª–æ–≤</h3>
        <div class="mass-action">
            <input type="number" class="glass-input" id="mass-glass-amount" placeholder="–ö–æ–ª-–≤–æ —Å—Ç–µ–∫–ª–æ–≤" min="1">
            <button class="glass-button" onclick="giveGlassToAll()">–í—ã–¥–∞—Ç—å –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</button>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="admin-section">
        <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        <div class="users-list">
            {% for user in users %}
            {% if user.id != 1 %}
            <div class="user-item glass-panel">
                <div class="user-info">
                    <span class="username">{{ user.username }}</span>
                    <span class="balance">ü™ô {{ user.glass_balance }} —Å—Ç–µ–∫–ª–æ–≤</span>
                    {% if user.is_banned %}
                    <span class="banned-badge">üö´ –ó–∞–±–∞–Ω–µ–Ω</span>
                    {% endif %}
                </div>
                <div class="admin-actions">
                    <input type="number" class="glass-input small" placeholder="–ö–æ–ª-–≤–æ" id="amount-{{ user.id }}">
                    <button class="glass-button small" onclick="giveGlass('{{ user.username }}', {{ user.id }})">
                        –í—ã–¥–∞—Ç—å
                    </button>
                    {% if not user.is_banned %}
                    <button class="glass-button small danger" onclick="banUser('{{ user.username }}')">
                        –ó–∞–±–∞–Ω–∏—Ç—å
                    </button>
                    {% else %}
                    <button class="glass-button small success" onclick="unbanUser('{{ user.username }}')">
                        –†–∞–∑–±–∞–Ω–∏—Ç—å
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="admin-actions-main">
        <a href="{{ url_for('main') }}" class="glass-button">–ù–∞–∑–∞–¥ –≤ —á–∞—Ç</a>
    </div>
</div>

<script>
document.getElementById('admin-user-search').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase().trim();
    const userItems = document.querySelectorAll('.user-item');

    if (!query) {
        userItems.forEach(item => item.style.display = 'flex');
        return;
    }

    userItems.forEach(item => {
        const username = item.querySelector('.username').textContent.toLowerCase();
        if (username.includes(query)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
});

function giveGlassToAll() {
    const amount = document.getElementById('mass-glass-amount').value;
    if (!amount || amount <= 0) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–µ–∫–ª–æ–≤');
        return;
    }

    if (confirm(`–í—ã–¥–∞—Ç—å ${amount} —Å—Ç–µ–∫–ª–æ–≤ –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
        fetch('/api/admin/give_glass_all', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ amount: parseInt(amount) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`${data.message} (${data.total_affected} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)`);
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        });
    }
}

function giveGlass(username, userId) {
    const amount = document.getElementById('amount-' + userId).value;
    if (!amount || amount <= 0) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
        return;
    }

    fetch('/api/admin/give_glass', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            username: username,
            amount: parseInt(amount)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('–°—Ç–µ–∫–ª—ã –≤—ã–¥–∞–Ω—ã! –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ' + data.new_balance);
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    });
}

function banUser(username) {
    if (confirm(`–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) {
        fetch('/api/admin/ban_user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: username })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            location.reload();
        });
    }
}

function unbanUser(username) {
    if (confirm(`–†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) {
        fetch('/api/admin/unban_user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: username })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            location.reload();
        });
    }
}
</script>

<style>
.admin-panel {
    max-width: 800px;
    margin: 20px auto;
    padding: 30px;
}

.mass-action {
    display: flex;
    gap: 10px;
    align-items: center;
}

.mass-action .glass-input {
    width: 150px;
}

.user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    margin-bottom: 15px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.banned-badge {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 12px;
    border: 1px solid rgba(244, 67, 54, 0.3);
}

.admin-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.admin-actions .glass-input.small {
    width: 80px;
    padding: 8px;
}

.admin-actions .glass-button.small {
    padding: 8px 12px;
    font-size: 12px;
}

.admin-section {
    margin-bottom: 30px;
}

.admin-section h3 {
    margin-bottom: 15px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
}
</style>
{% endblock %}
